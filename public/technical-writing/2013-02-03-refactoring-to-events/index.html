<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta name="generator" content="Hugo 0.79.0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Refactoring to Events #  Event-driven programming is a flexible weapon&hellip; like a whip. Design things right, and a flick of the wrist can roll down the length of your architecture and knock a cigarette out of a man&rsquo;s mouth with a supersonic snap. Design wrong, and a half-hour later you&rsquo;re in the emergency room with a wadded up T-shirt clamped to your forehead.
As a front-end developer, I&rsquo;ve whipped myself in the forehead more times than I care to count.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Refactoring to Events" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://alanmacdougall.com/technical-writing/2013-02-03-refactoring-to-events/" />

<title>Refactoring to Events | Alan MacDougall</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.0f40b4e83b0db00d11c595295e7f5f85f51436d20a5b6790534cb30c9f46a201.css" integrity="sha256-D0C06DsNsA0RxZUpXn9fhfUUNtIKW2eQU0yzDJ9GogE="><link rel="alternate" type="application/rss+xml" href="https://alanmacdougall.com/technical-writing/2013-02-03-refactoring-to-events/index.xml" title="Alan MacDougall" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>Alan MacDougall</span>
  </a>
</h2>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="https://alanmacdougall.com/professional-work/" class="">Professional Work</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2074b91aa0ad5b9c95e9ba3de764e002" class="toggle" checked />
    <label for="section-2074b91aa0ad5b9c95e9ba3de764e002" class="flex justify-between">
      <a href="https://alanmacdougall.com/technical-writing/" class="">Technical Writing</a>
      <span>â–¾</span>
    </label>
  

          
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/how-we-added-time-travel-to-paperless-post/" class="">How We Added Time Travel to Paperless Post</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-03-09-introducing-underscore-dot-as/" class="">Introducing underscore.as</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-03-10-anonymous-functions-in-as3/" class="">Anonymous Functions in AS3</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-03-10-understanding-closures-and-context/" class="">Understanding Closures and Context</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-03-10-closures-in-list-transformation/" class="">Closures in List Transformation</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-03-11-function-transformation/" class="">Function Transformation</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2013-02-03-refactoring-to-events/" class=" active">Refactoring to Events</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-03-27-using-vim-slime-with-pry-for-repl-perfection/" class="">Using vim-slime with pry for REPL perfection</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-06-08-interactive-debugging-with-pry/" class="">Interactive Debugging with Pry</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://alanmacdougall.com/technical-writing/2012-05-29-quick-block-uncommenting/" class="">Quick Block Uncommenting</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="https://alanmacdougall.com/side-projects/" class="">Side Projects</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="https://alanmacdougall.com/resume/" class="">Resume</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/amacdougall" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Refactoring to Events</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#refactoring-to-events">Refactoring to Events</a>
      <ul>
        <li><a href="#event-types">Event Types</a>
          <ul>
            <li><a href="#notifications">Notifications</a></li>
            <li><a href="#completions">Completions</a></li>
            <li><a href="#intents">Intents</a></li>
          </ul>
        </li>
        <li><a href="#response-and-responsibility">Response and Responsibility</a>
          <ul>
            <li><a href="#working-too-hard-_is_-hardly-working">Working Too Hard <em>Is</em> Hardly Working</a></li>
            <li><a href="#gratifaction">Gratifaction</a></li>
          </ul>
        </li>
        <li><a href="#tldr">tl;dr</a></li>
      </ul>
    </li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="refactoring-to-events">
  Refactoring to Events
  <a class="anchor" href="#refactoring-to-events">#</a>
</h1>
<p>Event-driven programming is a flexible weapon&hellip; like a whip. Design things
right, and a flick of the wrist can roll down the length of your architecture
and knock a cigarette out of a man&rsquo;s mouth with a supersonic snap. Design wrong,
and a half-hour later you&rsquo;re in the emergency room with a wadded up T-shirt
clamped to your forehead.</p>
<p>As a front-end developer, I&rsquo;ve whipped myself in the forehead more times than I
care to count. Do that often enough, and you start to get an intuition about
things. I&rsquo;ve got a theory about event handling: <em>make your decisions at the
right level of abstraction.</em></p>
<p>Maybe this is old hat. It should have been old hat to me, too, but you can&rsquo;t see
how old a hat is when you&rsquo;re wearing it. But first let&rsquo;s talk about kinds of
events.</p>
<blockquote class="book-hint info">
  This article was written in winter 2013, but every word still holds true.
</blockquote>

<h2 id="event-types">
  Event Types
  <a class="anchor" href="#event-types">#</a>
</h2>
<p>Events come in three flavors.</p>
<h3 id="notifications">
  Notifications
  <a class="anchor" href="#notifications">#</a>
</h3>
<p>When something happens in your application, and you want to respond to it
elsewhere, that causes another kind of event. I generally call these
&ldquo;notifications.&rdquo; Displaying a popup when there&rsquo;s new mail, or updating a view
when the underlying data changes, or checking for that damned 140-character
limit; those are all notifications. You aren&rsquo;t reporting on the results of a
delayed process, and crucially, you aren&rsquo;t directly handling a user action.</p>
<h3 id="completions">
  Completions
  <a class="anchor" href="#completions">#</a>
</h3>
<p>Sometimes you set a metaphorical wheel spinning, and you want to know when it
comes to rest. Downloads, uploads, API requests, background jobs of all kinds.
Maybe an actual wheel. Point is, you started it; you just don&rsquo;t know when it&rsquo;s
going to end. When it&rsquo;s done, you can continue with simple straight-line code. I
tend to just call these &ldquo;completion&rdquo; events.</p>
<h3 id="intents">
  Intents
  <a class="anchor" href="#intents">#</a>
</h3>
<p>The last big kind of event, and the topic of this article, is what I call an
&ldquo;intent.&rdquo; I borrowed the term from Android, and the new &ldquo;web intents&rdquo; that are
not quite sweeping the internet just yet. An event that forces a decision is an
intent. It could be user input, it could be server data that forces you down a
different code path: either way, new information just entered your system. You
might have to put an extra layer in your code to turn a plain-jane click into
something with a little more meat to it. Maybe something like this. Assume the
existence of an <code>Emitter</code> mixin which adds <code>on</code> and <code>emit</code> methods.</p>
<pre><code>Intents = {
  init: function() {
    var intents = this;

    // begin listening for events which reflect an intent
    $(&quot;#photos a.select-photo&quot;).on(&quot;click&quot;, function(event) {
      event.preventDefault();
      var photoId = $(this).data(&quot;photoId&quot;);
      intents.emit(&quot;intent:select-photo&quot;, photoId);
    });
  }
};

_(Intents).extend(Emitter);
</code></pre><p>Now your UI logic is held at arm&rsquo;s length: if you want to know that the user is
selecting a photo, you just handle the <code>intent:select-photo</code> event. Many UI
events could cause that intent to happen: a mouse click, a keyboard command, a
press of the undo button if your app has that functionality. And by the same
token, the intent could have more than one handler.</p>
<p>So far, we&rsquo;re just talking about an event dispatcher; in fact, it&rsquo;s not a long
step to get from here to the Command pattern, hooking the same command action up
to more than one UI component. But the real win here is conceptual: we don&rsquo;t
know <em>a priori</em> what a mouse click signifies, but &ldquo;select-photo&rdquo; plus a photo id
is unambiguous. This pattern saves you from keeping all your domain logic in a
briar patch of jQuery callbacks; but it also gives you concrete concepts to work
with as your application evolves.</p>
<h2 id="response-and-responsibility">
  Response and Responsibility
  <a class="anchor" href="#response-and-responsibility">#</a>
</h2>
<p>Sometimes, to handle an event, you need to make decisions. Should the user be
able to delete this photo? Does this link prompt a paywall? Should we display a
toast notification, and if so, what data should it contain? If the event handler
is close to the event source, this is easy: simply make the decision and move
on.</p>
<pre><code>photoSelector.on(&quot;select&quot;, function(event) {
  if (event.photo.someCondition == true) {
    takeAction();
  } else {
    displayError();
  }
});
</code></pre><p>Straightforward. Uncontroversial. But you know as well as I do that
&ldquo;straightforward&rdquo; never stays that way for very long.</p>
<h3 id="working-too-hard-_is_-hardly-working">
  Working Too Hard <em>Is</em> Hardly Working
  <a class="anchor" href="#working-too-hard-_is_-hardly-working">#</a>
</h3>
<p>Take Paperless Post. Users buy <em>coins</em>. You use coins to gussy up your cards.
Choosing a fancy card design uses coins, so when a user selects a new design, we
have to handle the <em>selection</em> by loading up the new graphics and adjusting the
layout&hellip; but we also have to add coins to the price of the card. If the card
used to be free, that means we have to display a paywall, and if not, we display
a brief message. On the paywall, if the user clicks the <em>cancel</em> button, we have
to undo the design change.</p>
<p>Hear that sound? That distant crashing, crumbling noise? Areas of concern,
smashing into each other and cracking and breaking and falling into the sea.</p>
<p>For a long time, we coded as if there was only one event happening here. The
user chose a new card design, and we handled it like this:</p>
<ol>
<li>Change the card design.</li>
<li>Show the right UI for the price change.</li>
</ol>
<p>But there are two events here, not one. First the user selects the design
change. We can handle that on the spot. Then the price changes. These are two
different things, no two ways about it. Instead, we should handle it like this:</p>
<ol>
<li>Change the card design.</li>
<li>Set the price.</li>
</ol>
<p>And then handle the price change somewhere else. Different component, maybe.
Heck, maybe a different architectural layer. You just have to ask yourself one
thing: &ldquo;Does this decision make sense here?&rdquo; If your selection handler is
displaying a paywall, you can bet your bottom dollar the answer is no.</p>
<p>In short, if your event handler is making too many decisions, look for a way to
spread that hard work around. If it worked for Tom Sawyer, it can work for you.</p>
<h3 id="gratifaction">
  Gratifaction
  <a class="anchor" href="#gratifaction">#</a>
</h3>
<p>Our situation at Paperless Post was more complicated than I&rsquo;m letting on. The
selection handler did not make the paywall decision&hellip; but it gathered
information for it. It looked something like this.</p>
<pre><code>linerSelector.on(&quot;change&quot;, function(event) {
  var newLiner = PP.assets.findById(event.id);
  var oldCost = PP.price.calculate();
  card.liner = newLiner;
  var newCost = PP.price.calculate(); // different result now

  PP.assets.emit(&quot;assetChanged&quot;, {
    asset: newLiner,
    oldCost: oldCost,
    newCost: newCost,
    undoFunction: function() {PP.history.backtrack();}
  });
});
</code></pre><p>Maybe we were too close to the barn to make out more than just some red painted
wood, but we had this in our codebase for a long time. Still do, in fact. But
now I know what&rsquo;s wrong. To decide whether to pop the paywall, we need to know
if the price went up. Sure. But why in heck is that code lumped in with the
liner setter? The price calculator should handle all that business by itself. It
should store its own snapshots of the past prices, and when it hears that
<code>assetChanged</code> event, it should do its own math.</p>
<h2 id="tldr">
  tl;dr
  <a class="anchor" href="#tldr">#</a>
</h2>
<p>Rule of thumb: put your decisions close to the events that prompt them. If an
event handler is doing too much work, maybe a new event type should exist in
your system. Don&rsquo;t worry that you are adding too many layers of abstraction. If
you design the abstractions right up front, sure, you end up with
<a href="http://static.springsource.org/spring/docs/2.5.x/api/org/springframework/aop/config/SimpleBeanFactoryAwareAspectInstanceFactory.html">SimpleBeanFactoryAwareAspectInstanceFactory</a>.
But if you have a problem, and a new layer of abstraction is the solution, don&rsquo;t
look a git horse in the commit.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#refactoring-to-events">Refactoring to Events</a>
      <ul>
        <li><a href="#event-types">Event Types</a>
          <ul>
            <li><a href="#notifications">Notifications</a></li>
            <li><a href="#completions">Completions</a></li>
            <li><a href="#intents">Intents</a></li>
          </ul>
        </li>
        <li><a href="#response-and-responsibility">Response and Responsibility</a>
          <ul>
            <li><a href="#working-too-hard-_is_-hardly-working">Working Too Hard <em>Is</em> Hardly Working</a></li>
            <li><a href="#gratifaction">Gratifaction</a></li>
          </ul>
        </li>
        <li><a href="#tldr">tl;dr</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












